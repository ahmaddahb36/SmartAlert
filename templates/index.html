<!DOCTYPE html>
<html lang="ar" dir="ltr">
  <head>
    <meta charset="UTF-8" />
    <title>Smart Alert Dashboard</title>
    <div class="dashboard-header">
        <div class="header-content">
            <h1 class="dashboard-title" >
                <i class="fas fa-shield-alt"></i size="100px" style="text-align: center;"> Smart Alert Dashboard
                          <span class="version-badge">v2.1</span>
            </h1>
            
            <div class="dashboard-status">
                <div class="status-item">
                    <div class="status-indicator active" id="connection-status"></div>
                    <span id="connection-text">Connected</span>
                </div>
                <div class="status-item">
                    <i class="fas fa-clock"></i>
                    <span class="current-time" id="current-time"></span>
                </div>
                <div class="status-item">
                    <i class="fas fa-server"></i>
                    <span id="data-updated">Last updated: Just now</span>
                </div>
            </div>
        </div>
        
    </div>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=VT323&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      .export-btn,
    .realtime-btn,
    .attacklog-btn {
      margin: 0.3rem;
      padding: 14px 32px;
      border-radius: 14px;
      background: linear-gradient(90deg, #38bdf8 0%, #00d4ff 100%);
      border: none;
      color: #222;
      font-family: "Roboto", sans-serif;
      font-size: 1.1rem;
      font-weight: 600;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 2px 12px rgba(56, 189, 248, 0.15);
    }
    .export-btn i,
    .realtime-btn i,
    .attacklog-btn i {
      font-size: 1.3rem;
      color: #222;
    }
    .export-btn:hover,
    .realtime-btn:hover,
    .attacklog-btn:hover {
      background: linear-gradient(90deg, #00d4ff 0%, #38bdf8 100%);
      color: #fff;
      box-shadow: 0 4px 18px rgba(56, 189, 248, 0.25);
      transform: translateY(-2px) scale(1.04);
    }
    .export-btn:active,
    .realtime-btn:active,
    .attacklog-btn:active {
      transform: scale(0.98);
    }
      body.light-theme .export-btn,
      body.light-theme .realtime-btn,
      body.light-theme .attacklog-btn {
        background: linear-gradient(135deg, #e6f0fa 0%, #c3cfe2 100%);
        color: #1c2526;
      }
      .export-btn:hover,
      .realtime-btn:hover,
      .attacklog-btn:hover {
        background: linear-gradient(135deg, #00d4ff 0%, #38bdf8 100%);
        color: #0f0f0f;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 212, 255, 0.4);
      }
      body.light-theme .export-btn:hover,
      body.light-theme .realtime-btn:hover,
      body.light-theme .attacklog-btn:hover {
        background: linear-gradient(135deg, #007bff 0%, #38bdf8 100%);
        color: #ffffff;
      }
      .table-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #101010;
        padding: 15px;
        border: 2px solid #19cae6;
        border-radius: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 10px;
        position: sticky;
        top: 0;
        z-index: 100;
        backdrop-filter: blur(10px);
        background: rgba(16, 16, 16, 0.9);
      }
      
      body.light-theme .table-controls {
        background: rgba(255, 255, 255, 0.9);
        border: 2px solid #19cae6;
      }
      .filter-group {
        background-color: #1c2526;
        border-radius: 12px;
        padding: .5rem;
        box-shadow: 0 4px 20px rgba(0, 212, 255, 0.15);
        margin-bottom: 1.5rem;
      }
      body.light-theme .filter-group {
        background-color: #ffffff;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }
      .filter-group h5 {
        color: #00d4ff;
        margin-bottom: 1rem;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      body.light-theme .filter-group h5 {
        color: #007bff;
      }
      .status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #4ade80;
    box-shadow: 0 0 10px #4ade80;
    transition: all 0.3s ease;
}
.status-indicator.inactive {
    background: #f87171;
    box-shadow: 0 0 10px #f87171;
}
      .status-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
}
      .dashboard-status {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
}
      .version-badge {
    background: rgba(0, 212, 255, 0.2);
    color: #00d4ff;
    font-size: 1.2rem;
    padding: 0.3rem 0.8rem;
    border-radius: 6px;
    margin-left: 0.8rem;
}
      .dashboard-title {
    color: #00d4ff;
    font-size: 2.5rem;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-family: "Share Tech Mono", monospace;
}
      .header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}
      .dashboard-header {
    background: rgba(30, 41, 59, 0.8);
    border-radius: 12px;
    padding: 1.5rem 2rem;
    margin-bottom: 1.5rem;
    border: 1px solid rgba(0, 212, 255, 0.3);
    box-shadow: 0 4px 20px rgba(0, 212, 255, 0.15);
}
      @keyframes pulse-attack {
        0% {
          box-shadow: 0 0 5px #ff4d4d;
        }
        50% {
          box-shadow: 0 0 20px #ff4d4d;
        }
        100% {
          box-shadow: 0 0 5px #ff4d4d;
        }
      }
      @keyframes glitch {
        0% {
          text-shadow: 2px 0 red, -2px 0 blue;
          transform: translate(0);
        }
        20% {
          text-shadow: -2px 0 lime, 2px 0 magenta;
          transform: translate(1px, -1px);
        }
        40% {
          text-shadow: 2px 2px cyan, -2px -2px yellow;
          transform: translate(-1px, 1px);
        }
        60% {
          text-shadow: -1px 1px red, 1px -1px blue;
          transform: translate(0.5px, -0.5px);
        }
        80% {
          text-shadow: 0 0 2px #00d4ff;
          transform: translate(0, 0);
        }
        100% {
          text-shadow: 0 0 2px #00d4ff;
          transform: translate(0, 0);
        }
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes spin {
        to {
          transform: translate(-50%, -50%) rotate(360deg);
        }
      }
      @keyframes bounce {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
      }
      body {
        background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
        color: #e0e0e0;
        font-family: "Roboto", sans-serif;
        padding: 3rem;
        position: relative;
        z-index: 0;
      }
      body.light-theme {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        color: #1c2526;
      }
      #particles-js {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
      }
      h2 {
        text-align: center;
        color: #00d4ff;
        text-shadow: 0 0 4px #00d4ff, 0 0 8px rgba(0, 212, 255, 0.5);
        font-family: "Press Start 2P", monospace;
        font-size: 32px;
        margin-bottom: 40px;
      }
      body.light-theme h2 {
        color: #007bff;
        text-shadow: 0 0 4px #007bff, 0 0 8px rgba(0, 123, 255, 0.5);
      }
      .table-container {
        overflow-x: auto;
        background-color: #1c1c1c;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 4px 30px rgba(0, 255, 204, 0.2);
        margin-bottom: 2rem;
        opacity: 0;
        animation: fadeIn 1s ease-in forwards;
        animation-delay: 0.2s;
        position: relative;
      }
      body.light-theme .table-container {
        background-color: #ffffff;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }
      .table {
        width: 100%;
        margin-bottom: 1rem;
        color: #f5f5f5;
        border-collapse: separate;
        border-spacing: 0;
      }
      .table thead th {
        background-color: #252525;
        color: #00d4ff;
        font-family: "Roboto", sans-serif;
        font-size: 1.1rem;
        font-weight: bold;
        text-align: left;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 20px 16px;
        text-shadow: 0 0 3px #00d4ff;
        border-bottom: 2px solid #444;
        transition: background-color 0.3s, color 0.3s;
      }
      body.light-theme .table thead th {
        background-color: #e9ecef;
        color: #007bff;
        text-shadow: none;
      }
      .table thead th:hover {
        background-color: #2a2a2a;
        color: #26c6da;
        cursor: pointer;
      }
      body.light-theme .table thead th:hover {
        background-color: #dee2e6;
      }
      .table tbody td {
        padding: 20px 16px;
        border-bottom: 1px solid #2a2a2a;
        vertical-align: middle;
        background-color: #1e1e1e;
        color: #ddd;
        font-size: 1rem;
        position: relative;
      }
      body.light-theme .table tbody td {
        background-color: #f8f9fa;
        color: #1c2526;
      }
      .table-hover tbody tr:hover {
        background-color: #2b2b2b !important;
        filter: brightness(1.15);
        box-shadow: 0 0 10px rgba(0, 255, 255, 0.15);
        cursor: pointer;
        transition: all 0.2s ease-in-out;
      }
      body.light-theme .table-hover tbody tr:hover {
        background-color: #e9ecef !important;
      }
      .pred-attack {
        background-color: #3b0000 !important;
        color: #ff4d4d !important;
        font-weight: bold;
        border-left: 6px solid #ff4d4d;
        text-shadow: 0 0 4px #ff4d4d, 0 0 8px rgba(255, 77, 77, 0.5);
        filter: brightness(1.25);
        animation: pulse-attack 1.8s infinite ease-in-out;
        box-shadow: 0 0 12px rgba(255, 77, 77, 0.5);
      }
      body.light-theme .pred-attack {
        background-color: #ffe6e6 !important;
        color: #d90429 !important;
        border-left: 6px solid #d90429;
        text-shadow: none;
        box-shadow: 0 0 12px rgba(217, 4, 41, 0.3);
      }
      .pred-other {
        background-color: #2f2f2f !important;
        color: #ffd700 !important;
        border-left: 5px solid #ffd700;
        text-shadow: 0 0 3px #ffd700;
      }
      body.light-theme .pred-other {
        background-color: #fff3cd !important;
        color: #856404 !important;
        border-left: 5px solid #856404;
      }
      .filter-btn {
        margin: 0.3rem;
        padding: 8px 20px;
        border-radius: 18px;
        background: linear-gradient(135deg, #1c2526 0%, #2d3748 100%);
        border: none;
        color: #e0e0e0;
        font-family: "Roboto", sans-serif;
        font-size: 0.80rem;
        font-weight: 500;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }
      body.light-theme .filter-btn {
        background: linear-gradient(135deg, #e6f0fa 0%, #c3cfe2 100%);
        color: #1c2526;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }
      .filter-btn:hover {
        background: linear-gradient(135deg, #00d4ff 0%, #38bdf8 100%);
        color: #0f0f0f;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 212, 255, 0.4);
      }
      body.light-theme .filter-btn:hover {
        background: linear-gradient(135deg, #007bff 0%, #38bdf8 100%);
        color: #ffffff;
      }
      .filter-btn.active {
        background: linear-gradient(135deg, #00d4ff 0%, #26c6da 100%);
        color: #0f0f0f;
        box-shadow: 0 4px 12px rgba(0, 212, 255, 0.5);
        transform: scale(1.05);
        animation: bounce 0.3s ease;
      }
      body.light-theme .filter-btn.active {
        background: linear-gradient(135deg, #007bff 0%, #339af0 100%);
        color: #ffffff;
      }
      
      .filter-container {
        opacity: 0;
        animation: fadeIn 1s ease-in forwards;
        animation-delay: 0.8s;
      }

      /* تصميم input التاريخ ليتناسق مع الداشبورد */
      #specificDate.form-control {
        background: linear-gradient(135deg, #1c2526 0%, #2d3748 100%);
        border: 1px solid #3a4a5c;
        border-radius: 18px;
        color: #e0e0e0;
        font-family: "Roboto", sans-serif;
        font-size: 0.80rem;
        font-weight: 500;
        padding: 8px 12px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        width: 150px !important;
      }

      body.light-theme #specificDate.form-control {
        background: linear-gradient(135deg, #e6f0fa 0%, #c3cfe2 100%);
        border: 1px solid #b8c5d1;
        color: #1c2526;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }

      #specificDate.form-control:focus {
        background: linear-gradient(135deg, #2a363a 0%, #374151 100%);
        border-color: #00d4ff;
        box-shadow: 0 0 0 0.2rem rgba(0, 212, 255, 0.25), 0 4px 12px rgba(0, 212, 255, 0.3);
        outline: none;
        color: #ffffff;
      }

      body.light-theme #specificDate.form-control:focus {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25), 0 4px 12px rgba(0, 123, 255, 0.3);
        color: #1c2526;
      }

      #specificDate.form-control::-webkit-calendar-picker-indicator {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23e0e0e0'%3e%3cpath d='M5.5 0a.5.5 0 0 1 .5.5V1h4V.5a.5.5 0 0 1 1 0V1h.5A1.5 1.5 0 0 1 13 2.5v11A1.5 1.5 0 0 1 11.5 15h-7A1.5 1.5 0 0 1 3 13.5v-11A1.5 1.5 0 0 1 4.5 1H5V.5a.5.5 0 0 1 .5-.5zM4.5 2a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-7z'/%3e%3c/svg%3e");
        filter: none;
        width: 20px;
        height: 20px;
        cursor: pointer;
        opacity: 0.8;
        transition: opacity 0.3s ease;
      }

      body.light-theme #specificDate.form-control::-webkit-calendar-picker-indicator {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%231c2526'%3e%3cpath d='M5.5 0a.5.5 0 0 1 .5.5V1h4V.5a.5.5 0 0 1 1 0V1h.5A1.5 1.5 0 0 1 13 2.5v11A1.5 1.5 0 0 1 11.5 15h-7A1.5 1.5 0 0 1 3 13.5v-11A1.5 1.5 0 0 1 4.5 1H5V.5a.5.5 0 0 1 .5-.5zM4.5 2a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5h-7z'/%3e%3c/svg%3e");
      }

      #specificDate.form-control::-webkit-calendar-picker-indicator:hover {
        opacity: 1;
        transform: scale(1.1);
      }

      /* تصميم label التاريخ */
      .date-label {
        color: #e0e0e0;
        font-family: "Roboto", sans-serif;
        font-size: 0.80rem;
        font-weight: 500;
        margin-bottom: 0;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      }

      body.light-theme .date-label {
        color: #1c2526;
        text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
      }
      .filter-header {
        cursor: pointer;
        user-select: none;
      }
      .filter-content {
        display: block;
      }
      .filter-content.collapsed {
        display: none;
      }
      @media (max-width: 768px) {
        .table thead {
          display: none;
        }
        .table,
        .table tbody,
        .table tr,
        .table td {
          display: block;
          width: 100%;
        }
        .table tr {
          margin-bottom: 1.5rem;
          border-radius: 8px;
          overflow: hidden;
        }
        .table td {
          text-align: right;
          padding: 14px 16px;
          position: relative;
          font-size: 0.95rem;
        }
        .table td::before {
          content: attr(data-label);
          position: absolute;
          left: 1.2rem;
          width: 40%;
          padding-right: 1.2rem;
          font-weight: 600;
          text-align: left;
          color: #00d4ff;
        }
        body.light-theme .table td::before {
          color: #007bff;
        }
        .filter-btn {
          padding: 12px 24px;
          font-size: 1rem;
          width: 100%;
          margin: 0.3rem 0;
        }
        .chart-container,
        .map-container {
          max-width: 100%;
          max-height: 350px;
          padding: 15px;
          margin-bottom: 20px;
        }
      }
      .alert-primary {
        font-size: 1rem !important;
        background: #1e293b !important;
        color: #e5e7ef !important;
        border: 1.5px solid #38bdf8 !important;
        box-shadow: 0 4px 16px rgba(56, 189, 248, 0.2) !important;
        border-radius: 10px !important;
        margin-top: 10px !important;
        padding: 18px 20px !important;
        transition: box-shadow 0.2s !important;
      }
      body.light-theme .alert-primary {
        background: #e6f0fa !important;
        color: #1c2526 !important;
        border: 1.5px solid #007bff !important;
        box-shadow: 0 4px 16px rgba(0, 123, 255, 0.2) !important;
      }
      .alert-primary b {
        color: #38bdf8 !important;
        letter-spacing: 0.5px !important;
      }
      body.light-theme .alert-primary b {
        color: #0056b3 !important;
      }
      .alert-primary:hover {
        box-shadow: 0 6px 24px rgba(56, 189, 248, 0.3) !important;
      }
      body.light-theme .alert-primary:hover {
        box-shadow: 0 6px 24px rgba(0, 123, 255, 0.3) !important;
      }
      .chart-container,
      .map-container {
        display: flex;
        justify-content: center;
        align-items: center;
        max-width: 550px;
        max-height: 550px;
        padding: 20px;
        background: #1c1c1c;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 212, 255, 0.15);
        opacity: 0;
        animation: fadeIn 1s ease-in forwards;
        animation-delay: 0.4s;
        margin: 0 auto;
      }
      body.light-theme .chart-container,
      body.light-theme .map-container {
        background: #ffffff;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }
      .ai-analyze-btn {
        position: relative;
        padding: 8px 16px;
        border-radius: 8px;
        transition: all 0.3s ease;
      }
      .ai-analyze-btn:disabled {
        opacity: 0.7;
      }
      .ai-analyze-btn.working::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        border: 2px solid #00d4ff;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        transform: translate(-50%, -50%);
      }
      body.light-theme .ai-analyze-btn.working::after {
        border: 2px solid #007bff;
        border-top-color: transparent;
      }
      .glitch-animate {
        animation: glitch 0.5s steps(2, end);
      }
      .search-container {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 1rem;
      }
      .search-input {
        background: #2d3748;
        border: 1px solid #00d4ff;
        color: #e0e0e0;
        border-radius: 8px;
        padding: 10px;
        width: 100%;
        max-width: 300px;
      }
      body.light-theme .search-input {
        background: #e6f0fa;
        border: 1px solid #007bff;
        color: #1c2526;
      }
      
      .row-tooltip {
        position: absolute;
        background: #1e293b;
        color: #e5e7ef;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.85rem;
        z-index: 10;
        display: none;
        pointer-events: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }
      body.light-theme .row-tooltip {
        background: #e6f0fa;
        color: #1c2526;
        border: 1px solid #007bff;
      }
      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(28, 28, 28, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 10;
      }
      body.light-theme .loading-overlay {
        background: rgba(255, 255, 255, 0.8);
      }
      .loading-spinner::after {
        content: "";
        width: 40px;
        height: 40px;
        border: 4px solid #00d4ff;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      body.light-theme .loading-spinner::after {
        border: 4px solid #007bff;
        border-top-color: transparent;
      }
      .filter-count {
        background: #00d4ff;
        color: #0f0f0f;
        border-radius: 12px;
        padding: 2px 8px;
        font-size: 0.8rem;
        margin-left: 8px;
      }
      body.light-theme .filter-count {
        background: #007bff;
        color: #ffffff;
      }
      
      /* زر العودة لأعلى الصفحة */
      .back-to-top {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #00d4ff 0%, #38bdf8 100%);
        color: #000;
        border: none;
        border-radius: 50%;
        font-size: 24px;
        cursor: pointer;
        opacity: 0;
        visibility: hidden;
        transform: scale(0.8);
        transition: all 0.3s ease;
        z-index: 1000;
        box-shadow: 0 4px 20px rgba(0, 212, 255, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .back-to-top.show {
        opacity: 1;
        visibility: visible;
        transform: scale(1);
      }
      
      .back-to-top:hover {
        background: linear-gradient(135deg, #38bdf8 0%, #00d4ff 100%);
        transform: scale(1.1);
        box-shadow: 0 6px 24px rgba(0, 212, 255, 0.6);
      }
      
      .back-to-top:active {
        transform: scale(0.95);
      }
      
      body.light-theme .back-to-top {
        background: linear-gradient(135deg, #007bff 0%, #339af0 100%);
        color: #fff;
        box-shadow: 0 4px 20px rgba(0, 123, 255, 0.4);
      }
      
      body.light-theme .back-to-top:hover {
        background: linear-gradient(135deg, #339af0 0%, #007bff 100%);
        box-shadow: 0 6px 24px rgba(0, 123, 255, 0.6);
      }
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background: #1c2526;
        padding: 20px;
        border-radius: 12px;
        max-width: 600px;
        width: 90%;
        color: #e0e0e0;
        position: relative;
      }
      body.light-theme .modal-content {
        background: #ffffff;
        color: #1c2526;
      }
      .modal-close {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 1.5rem;
        cursor: pointer;
        color: #00d4ff;
      }
      body.light-theme .modal-close {
        color: #007bff;
      }
      .saved-search-container {
        margin-bottom: 1rem;
      }
      .saved-search-input {
        background: #2d3748;
        border: 1px solid #00d4ff;
        color: #e0e0e0;
        border-radius: 8px;
        padding: 10px;
        width: 100%;
        max-width: 200px;
      }
      body.light-theme .saved-search-input {
        background: #e6f0fa;
        border: 1px solid #007bff;
        color: #1c2526;
      }
      .time-range-select {
        background: #2d3748;
        border: 1px solid #00d4ff;
        color: #e0e0e0;
        border-radius: 8px;
        padding: 10px;
        width: 100%;
        max-width: 200px;
      }
      body.light-theme .time-range-select {
        background: #e6f0fa;
        border: 1px solid #007bff;
        color: #1c2526;
      }
      .table-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #101010;
        padding: 15px;
        border: 2px solid #19cae6;
        border-radius: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 10px;
      }
      .search-input,
      .export-btn,
      .realtime-btn,
      .attacklog-btn,
      .time-range-select {
        padding: 10px 12px;
        font-size: 14px;
        border-radius: 6px;
        border: none;
        outline: none;
      }
      .search-input {
        flex: 1;
        min-width: 200px;
        background-color: #1a1a1a;
        color: #fff;
        border: 1px solid #19cae6;
      }
      .export-btn,
      .realtime-btn,
      .attacklog-btn {
        background-color: #19cae6;
        color: #000;
        cursor: pointer;
      }
      .time-range-select {
        background-color: #1a1a1a;
        color: #fff;
        border: 1px solid #19cae6;
      }
    </style>
  </head>
  <body>
    <div id="particles-js"></div>
    
    <div class="container">
      <div class="d-flex justify-content-end mb-3">
        <button
          id="theme-toggle"
          class="btn filter-btn"
          aria-label="Toggle theme"
        >
          <i class="fas fa-moon"></i> Toggle Theme
        </button>
      </div>
      {% if prediction_counts %}
      <div class="row mb-4">
        <div class="col-lg-4 filter-container">
          <div class="filter-group">
            <h5 class="filter-header">
              <i class="fas fa-filter"></i> Filter by Prediction
              <i class="fas fa-chevron-down"></i>
              <span class="filter-count" id="pred-filter-count">0</span>
            </h5>
            <div class="filter-content">
              <div class="d-flex flex-wrap gap-2">
                <button
                  class="btn filter-btn active"
                  onclick="filterTable('all')"
                  data-filter="all"
                  aria-pressed="true"
                >
                  <i class="fas fa-list"></i> Show All
                </button>
                {% for label in prediction_counts.keys() %}
                <button
                  class="btn filter-btn"
                  onclick="filterTable('{{ label }}')"
                  data-filter="{{ label }}"
                  aria-pressed="false"
                >
                  <i class="fas fa-filter"></i> {{ label }}
                </button>
                {% endfor %}
              </div>
            </div>
          </div>
          <div class="filter-group">
            <h5 class="filter-header">
              <i class="fas fa-clock"></i> Filter by Time
              <i class="fas fa-chevron-down"></i>
              <span class="filter-count" id="time-filter-count">0</span>
            </h5>
            <div class="filter-content">
              <div class="d-flex flex-wrap gap-2">
                <button
                  class="btn filter-btn active"
                  onclick="filterByTime('all')"
                  data-time-filter="all"
                  aria-pressed="true"
                >
                  <i class="fas fa-clock"></i> All
                </button>
                <button
                  class="btn filter-btn"
                  onclick="filterByTime('today')"
                  data-time-filter="today"
                  aria-pressed="false"
                >
                  <i class="fas fa-calendar-day"></i> Today
                </button>
                <button
                  class="btn filter-btn"
                  onclick="filterByTime('week')"
                  data-time-filter="week"
                  aria-pressed="false"
                >
                  <i class="fas fa-calendar-week"></i> This Week
                </button>
                <button
                  class="btn filter-btn"
                  onclick="filterByTime('month')"
                  data-time-filter="month"
                  aria-pressed="false"
                >
                  <i class="fas fa-calendar-alt"></i> This Month
                </button>
                <div class="d-flex align-items-center gap-2 mt-2">
                  <label for="specificDate" class="text-nowrap date-label"
                    >Specific Date:</label
                  >
                  <input
                    type="date"
                    id="specificDate"
                    class="form-control"
                    style="width: 150px"
                  />
                  <button
                    class="btn filter-btn"
                    onclick="filterByTime('specific')"
                    data-time-filter="specific"
                    aria-pressed="false"
                  >
                    <i class="fas fa-calendar-check"></i> Filter by Date
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-8">
          <div class="chart-container">
            <canvas id="predictionChart"></canvas>
          </div>
          
        </div>
      </div>
      {% endif %} {% if results and results[0] is mapping %}
      <div class="table-controls">
        <span class="control-label">Search:</span>
        <input
          type="text"
          id="table-search"
          class="search-input"
          placeholder="Search by IP or Prediction..."
          aria-label="Search table by IP or Prediction"
          oninput="searchTable()"
        />

        <select
          id="time-range-select"
          class="time-range-select"
          aria-label="Select time range"
        >
          <option value="all">All Time</option>
          <option value="24h">Last 24 Hours</option>
          <option value="7d">Last 7 Days</option>
          <option value="30d">Last 30 Days</option>
        </select>
        <button
          class="btn export-btn"
          onclick="exportTableToCSV()"
          aria-label="Export table to CSV"
        >
          <i class="fas fa-download"></i> Export to CSV
        </button>
        <button
          class="btn realtime-btn"
          onclick="loadRealTimeData()"
          aria-label="Load Real-Time Data"
        >
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
        <button
          class="btn attacklog-btn"
          onclick="loadAttackLogData()"
          aria-label="Load Attack Log Data"
        >
          <i class="fas fa-exclamation-triangle"></i> Attack Log
        </button>
      </div>
      <div class="table-container">
        <div class="loading-overlay loading-spinner" id="table-loading"></div>
        <div
          aria-live="polite"
          id="filter-status"
          class="visually-hidden"
        ></div>
        
        <table class="table table-bordered table-hover text-center">
          <thead>
            <tr>
              <th>NO.</th>
              <th>Source IP</th>
              <th>Destination IP</th>
              <th>Protocol</th>
              <th>Destination Port</th>
              <th>TIMESPAN</th>
              <th>Flow Duration (μs)</th>
              <th>Total Fwd Pkts</th>
              <th>Total Bwd Pkts</th>
              <th>Bytes/sec</th>
              <th>Packets/sec</th>
              <th>Prediction</th>
              <th>AI Recommendations</th>
            </tr>
          </thead>
          <tbody id="result-table">
            {% for row in results %} {% set pred = row['Prediction'] | lower %}
            <tr
              data-pred="{{ row['Prediction'] }}"
              class="{% if 'benign' in pred %}pred-benign {% elif 'attack' in pred or 'ddos' in pred or 'dos' in pred or 'brute' in pred or 'sql' in pred or 'ssh' in pred or 'infiltration' in pred %}pred-attack {% else %}pred-other{% endif %}"
              tabindex="0"
              data-row="{{ row | tojson | safe }}"
            >
              <td data-label="NO.">{{ loop.index }}</td>
              {% for key, value in row.items() %} {% if key == 'Protocol' %}
              <td data-label="Protocol">
                {% if value == 6 or value == '6' %} TCP {% elif value == 17 or
                value == '17' %} UDP {% elif value == 1 or value == '1' %} ICMP
                {% else %} {{ value }} {% endif %}
              </td>
              {% else %}
              <td data-label="{{ key }}">{{ value }}</td>
              {% endif %} {% endfor %}
              <td data-label="AI Recommendations">
                {% if 'benign' not in pred %}
                <button
                  class="btn btn-info ai-analyze-btn"
                  data-row="{{ row | tojson | safe }}"
                  onclick='analyzeRow(JSON.parse(this.getAttribute("data-row")), this)'
                >
                  AI Recommendations
                </button>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="alert alert-warning text-center mt-5">
        ⚠️ No data loaded or analysis error occurred.
      </p>
      {% endif %}
      <div class="modal" id="row-details-modal">
        <div class="modal-content">
          <span class="modal-close" onclick="closeModal()">&times;</span>
          <h3>Event Details</h3>
          <div id="modal-content"></div>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script>

  window.onload = function () {
    document.querySelector('.realtime-btn').click();
  };



      particlesJS("particles-js", {/////////////////////////////////////////////////////////////////// background
        particles: {
          number: { value: 300 },
          color: { value: "#38bdf8" },
          shape: { type: "circle" },
          opacity: { value: 0.3, random: true },
          size: { value: 3, random: true },
          line_linked: {
            enable: true,
            distance: 120,
            color: "#38bdf8",
            opacity: 0.3,
            width: 2,
          },
          move: {
            enable: true,
            speed: 2,
            direction: "none",
            random: false,
            straight: false,
            out_mode: "out",
          },
        },
        interactivity: {
          detect_on: "canvas",
          events: {
            onhover: { enable: true, mode: "repulse" },
            onclick: { enable: true, mode: "push" },
          },
          modes: {
            repulse: { distance: 80 },
            push: { particles_nb: 3 },
          },
        },
        retina_detect: true,
      });

      let autoRefresh = true;
      let refreshInterval;
      let userActiveTimeout;
      let savedSearches =
        JSON.parse(localStorage.getItem("savedSearches")) || [];


      function startAutoRefresh() {/////////////////////////////////////////////////////refresh
        refreshInterval = setInterval(() => {
          if (autoRefresh) {
            // Instead of reloading the page, call the loadRealTimeData function
            loadRealTimeData();
          }
        }, 20000);
      }

      function pauseAutoRefresh() {
        autoRefresh = false;
        clearTimeout(userActiveTimeout);
        userActiveTimeout = setTimeout(() => {
          autoRefresh = true;
        }, 50000);
      }

      ["mousemove", "keydown", "scroll", "mousedown", "touchstart"].forEach(
        (evt) => {
          window.addEventListener(evt, pauseAutoRefresh, { passive: true });
        }
      );

      startAutoRefresh();

      function showLoading() {
        document.getElementById("table-loading").style.display = "flex";
      }

      function hideLoading() {
        document.getElementById("table-loading").style.display = "none";
      }

      function updateFilterStatus(message) {
        const status = document.getElementById("filter-status");
        status.textContent = message;
      }

      function updateFilterCounts() {
        const rows = document.querySelectorAll("#result-table tr");
        let visibleCount = 0;
        rows.forEach((row) => {
          if (row.style.display !== "none") visibleCount++;
        });
        document.getElementById("pred-filter-count").textContent = visibleCount;
        document.getElementById("time-filter-count").textContent = visibleCount;
        updateFilterStatus(`Showing ${visibleCount} records after filtering`);
      }

      function filterTable(prediction) {
        showLoading();
        setTimeout(() => {
          const rows = document.querySelectorAll("#result-table tr");
          const buttons = document.querySelectorAll("[data-filter]");
          buttons.forEach((btn) => {
            btn.classList.toggle("active", btn.dataset.filter === prediction);
            btn.setAttribute("aria-pressed", btn.dataset.filter === prediction);
          });
          rows.forEach((row) => {
            row.style.display =
              prediction === "all" || row.dataset.pred === prediction
                ? ""
                : "none";
          });
          updateChart();
          updateMap();
          updateFilterCounts();
          hideLoading();
        }, 300);
      }

      function filterByTime(range) {
        showLoading();
        setTimeout(() => {
          const rows = document.querySelectorAll("#result-table tr");
          const buttons = document.querySelectorAll("[data-time-filter]");
          buttons.forEach((btn) => {
            btn.classList.toggle("active", btn.dataset.timeFilter === range);
            btn.setAttribute("aria-pressed", btn.dataset.timeFilter === range);
          });
          const now = new Date();

          rows.forEach((row) => {
            const timeCell = row.children[5];
            if (!timeCell) return;

            const timestampStr = timeCell.textContent.trim();
            const timestamp = new Date(timestampStr);

            let show = true;

            if (range === "today") {
              show = timestamp.toDateString() === now.toDateString();
            } else if (range === "week") {
  const weekStart = new Date(now);
  weekStart.setDate(now.getDate() - now.getDay());
  weekStart.setHours(0, 0, 0, 0); // بداية اليوم
  
  const weekEnd = new Date(weekStart);
  weekEnd.setDate(weekStart.getDate() + 6);
  weekEnd.setHours(23, 59, 59, 999); // نهاية اليوم
  
  show = timestamp >= weekStart && timestamp <= weekEnd;
            } else if (range === "month") {
              show =
                timestamp.getMonth() === now.getMonth() &&
                timestamp.getFullYear() === now.getFullYear();
            } else if (range === "specific") {
              const specificDate = new Date(
                document.getElementById("specificDate").value
              );
              if (specificDate.toString() !== "Invalid Date") {
                show = timestamp.toDateString() === specificDate.toDateString();
              } else {
                show = true;
              }
            }

            row.style.display = range === "all" || show ? "" : "none";
          });
          updateChart();
          updateMap();
          updateFilterCounts();
          hideLoading();
        }, 300);
      }

      function filterByTimeRange(range) {
        showLoading();
        setTimeout(() => {
          const rows = document.querySelectorAll("#result-table tr");
          const now = new Date();
          rows.forEach((row, index) => {
            const timeCell = row.children[5];
            if (!timeCell) {
              console.error(`Row ${index}: TIMESPAN cell not found`);
              return;
            }
            const timestampStr = timeCell.textContent.trim();
            const timestamp = new Date(timestampStr);
            console.log(`Row ${index} Timestamp:`, timestampStr, timestamp);
            let show = true;
            if (range === "24h") {
              const start = new Date(now.getTime() - 24 * 60 * 60 * 1000);
              show =
                timestamp >= start && timestamp <= now && !isNaN(timestamp);
            } else if (range === "7d") {
              const start = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
              show =
                timestamp >= start && timestamp <= now && !isNaN(timestamp);
            } else if (range === "30d") {
              const start = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
              show =
                timestamp >= start && timestamp <= now && !isNaN(timestamp);
            }
            row.style.display = range === "all" || show ? "" : "none";
          });
          updateChart();
          updateMap();
          updateFilterCounts();
          hideLoading();
        }, 300);
      }

      function searchTable() {
        const query =
          document
            .getElementById("table-search")
            ?.value.trim()
            .toLowerCase() || "";
        const rows = document.querySelectorAll("#result-table tr");
        let visibleCount = 0;

        if (!query) {
          // إذا كان البحث فارغ، أظهر جميع الصفوف
          rows.forEach((row) => {
            row.style.display = "";
            visibleCount++;
          });
        } else {
          // إذا كان هناك نص بحث، ابحث في الصفوف
          rows.forEach((row, index) => {
            const sourceIP =
              row.children[1]?.textContent.trim().toLowerCase() || "";
            const destIP =
              row.children[2]?.textContent.trim().toLowerCase() || "";
            const prediction = row.dataset.pred?.trim().toLowerCase() || "";
            const protocol =
              row.children[3]?.textContent.trim().toLowerCase() || "";
            const port =
              row.children[4]?.textContent.trim().toLowerCase() || "";

            const matches =
              sourceIP.includes(query) ||
              destIP.includes(query) ||
              prediction.includes(query) ||
              protocol.includes(query) ||
              port.includes(query);

            if (matches) {
              row.style.display = "";
              visibleCount++;
            } else {
              row.style.display = "none";
            }
          });
        }

        updateChart();
        updateMap();
        updateFilterCounts();
        updateFilterStatus(`Showing ${visibleCount} records after search`);
      }

      function exportTableToCSV() {
        const rows = document.querySelectorAll("#result-table tr");
        let csv = [];
        const headers = Array.from(
          document.querySelectorAll(".table thead th")
        ).map((th) => th.textContent);
        csv.push(headers.join(","));

        rows.forEach((row) => {
          if (row.style.display !== "none") {
            const cells = Array.from(row.children).map(
              (cell) => `"${cell.textContent.replace(/"/g, '""')}"`
            );
            csv.push(cells.join(","));
          }
        });

        const csvContent = csv.join("\n");
        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "smart_alert_dashboard.csv";
        link.click();
        URL.revokeObjectURL(link.href);
      }

      function saveSearch() {
        const name = document.getElementById("saved-search-name")?.value;
        if (!name) return alert("Please enter a name for the saved search");
        const predFilter =
          document.querySelector("[data-filter].active")?.dataset.filter ||
          "all";
        const timeFilter =
          document.querySelector("[data-time-filter].active")?.dataset
            .timeFilter || "all";
        const timeRange = document.getElementById("time-range-select").value;
        const specificDate = document.getElementById("specificDate").value;
        savedSearches.push({
          name,
          predFilter,
          timeFilter,
          timeRange,
          specificDate,
        });
        localStorage.setItem("savedSearches", JSON.stringify(savedSearches));
        updateSavedSearches();
        document.getElementById("saved-search-name").value = "";
      }

      function updateSavedSearches() {
        const select = document.getElementById("saved-searches");
        if (select) {
          select.innerHTML = '<option value="">Load Saved Search</option>';
          savedSearches.forEach((search, index) => {
            const option = document.createElement("option");
            option.value = index;
            option.textContent = search.name;
            select.appendChild(option);
          });
        }
      }

      function loadSavedSearch() {
        const index = document.getElementById("saved-searches")?.value;
        if (!index) return;
        const search = savedSearches[index];
        filterTable(search.predFilter);
        filterByTime(search.timeFilter);
        document.getElementById("time-range-select").value = search.timeRange;
        filterByTimeRange(search.timeRange);
        if (search.specificDate) {
          document.getElementById("specificDate").value = search.specificDate;
          if (search.timeFilter === "specific") filterByTime("specific");
        }
      }

      function showModal(rowData) {
        const modal = document.getElementById("row-details-modal");
        const content = document.getElementById("modal-content");
        content.innerHTML = `
          <p><strong>Source IP:</strong> ${rowData["Source IP"]}</p>
          <p><strong>Destination IP:</strong> ${rowData["Destination IP"]}</p>
          <p><strong>Protocol:</strong> ${
            rowData["Protocol"] == 6
              ? "TCP"
              : rowData["Protocol"] == 17
              ? "UDP"
              : rowData["Protocol"] == 1
              ? "ICMP"
              : rowData["Protocol"]
          }</p>
          <p><strong>Destination Port:</strong> ${
            rowData["Destination Port"]
          }</p>
          <p><strong>Timespan:</strong> ${rowData["TIMESPAN"]}</p>
          <p><strong>Flow Duration (μs):</strong> ${
            rowData["Flow Duration (μs)"]
          }</p>
          <p><strong>Total Fwd Packets:</strong> ${
            rowData["Total Fwd Pkts"]
          }</p>
          <p><strong>Total Bwd Packets:</strong> ${
            rowData["Total Bwd Pkts"]
          }</p>
          <p><strong>Bytes/sec:</strong> ${rowData["Bytes/sec"]}</p>
          <p><strong>Packets/sec:</strong> ${rowData["Packets/sec"]}</p>
          <p><strong>Prediction:</strong> ${rowData["Prediction"]}</p>
        `;
        modal.style.display = "flex";
      }

      function closeModal() {
        document.getElementById("row-details-modal").style.display = "none";
      }

      async function loadRealTimeData() {
        showLoading();
        try {
          const response = await fetch("/realtime_data", {
            method: "GET",
            headers: { "Content-Type": "application/json" },
          });
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          const data = await response.json();
          updateTable(data.results, data.prediction_counts);
          resetFilters();
          updateChart();
          updateMap();
          updateFilterCounts();
          updateFilterStatus("Real-time data loaded");
        } catch (error) {
          console.error("Error fetching real-time data:", error);
          alert("Failed to load real-time data");
        } finally {
          hideLoading();
        }
      }

      async function loadAttackLogData() {
        showLoading();
        try {
          const response = await fetch("/attack_log_data", {
            method: "GET",
            headers: { "Content-Type": "application/json" },
          });
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          const data = await response.json();
          updateTable(data.results, data.prediction_counts);
          applyCurrentFilters();
          updateChart();
          updateMap();
          updateFilterCounts();
          updateFilterStatus("Attack log data loaded");
        } catch (error) {
          console.error("Error fetching attack log data:", error);
          alert("Failed to load attack log data");
        } finally {
          hideLoading();
        }
      }

      function updateTable(results, predictionCounts) {
        const tbody = document.getElementById("result-table");
        tbody.innerHTML = "";
        results.forEach((row, index) => {
          const pred = row["Prediction"].toLowerCase();
          const tr = document.createElement("tr");
          tr.dataset.pred = row["Prediction"];
          tr.className = pred.includes("benign")
            ? "pred-benign"
            : pred.includes("attack") ||
              pred.includes("ddos") ||
              pred.includes("dos") ||
              pred.includes("brute") ||
              pred.includes("sql") ||
              pred.includes("ssh") ||
              pred.includes("infiltration")
            ? "pred-attack"
            : "pred-other";
          tr.tabIndex = 0;
          tr.dataset.row = JSON.stringify(row);
          tr.innerHTML = `
            <td data-label="NO.">${index + 1}</td>
            <td data-label="Source IP">${row["Source IP"]}</td>
            <td data-label="Destination IP">${row["Destination IP"]}</td>
            <td data-label="Protocol">${
              row["Protocol"] == 6
                ? "TCP"
                : row["Protocol"] == 17
                ? "UDP"
                : row["Protocol"] == 1
                ? "ICMP"
                : row["Protocol"]
            }</td>
            <td data-label="Destination Port">${row["Destination Port"]}</td>
            <td data-label="TIMESPAN">${row["TIMESPAN"]}</td>
            <td data-label="Flow Duration (μs)">${
              row["Flow Duration (μs)"]
            }</td>
            <td data-label="Total Fwd Pkts">${row["Total Fwd Pkts"]}</td>
            <td data-label="Total Bwd Pkts">${row["Total Bwd Pkts"]}</td>
            <td data-label="Bytes/sec">${row["Bytes/sec"]}</td>
            <td data-label="Packets/sec">${row["Packets/sec"]}</td>
            <td data-label="Prediction">${row["Prediction"]}</td>
            <td data-label="AI Recommendations">
              ${
                !pred.includes("benign")
                  ? `<button class="btn btn-info ai-analyze-btn" data-row='${JSON.stringify(
                      row
                    )}' onclick='analyzeRow(JSON.parse(this.getAttribute("data-row")), this)'>AI Recommendations</button>`
                  : ""
              }
            </td>
          `;
          tbody.appendChild(tr);
        });

        // Re-attach event listeners for rows
        document.querySelectorAll("#result-table tr").forEach((row) => {
          row.addEventListener("click", () => {
            const rowData = JSON.parse(row.dataset.row);
            showModal(rowData);
          });
          row.addEventListener("mouseenter", (e) => {
            const sourceIP = row.children[1].textContent;
            const destIP = row.children[2].textContent;
            const prediction = row.dataset.pred;
            const tooltip = document.createElement("div");
            tooltip.className = "row-tooltip";
            tooltip.textContent = `Source IP: ${sourceIP}\nDestination IP: ${destIP}\nPrediction: ${prediction}`;
            document.body.appendChild(tooltip);
            const rect = row.getBoundingClientRect();
            tooltip.style.top = `${
              rect.top + window.scrollY - tooltip.offsetHeight - 10
            }px`;
            tooltip.style.left = `${
              rect.left + window.scrollX + rect.width / 2
            }px`;
            tooltip.style.display = "block";
          });
          row.addEventListener("mouseleave", () => {
            document
              .querySelectorAll(".row-tooltip")
              .forEach((t) => t.remove());
          });
          row.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              const aiButton = row.querySelector(".ai-analyze-btn");
              if (aiButton) aiButton.click();
              else showModal(JSON.parse(row.dataset.row));
            }
          });
        });

        // Update prediction filter buttons
        const filterGroup = document.querySelector(
          ".filter-group .filter-content .d-flex"
        );
        filterGroup.innerHTML = `
          <button class="btn filter-btn active" onclick="filterTable('all')" data-filter="all" aria-pressed="true">
            <i class="fas fa-list"></i> Show All
          </button>
        `;
        Object.keys(predictionCounts).forEach((label) => {
          const btn = document.createElement("button");
          btn.className = "btn filter-btn";
          btn.dataset.filter = label;
          btn.setAttribute("aria-pressed", "false");
          btn.innerHTML = `<i class="fas fa-filter"></i> ${label}`;
          btn.onclick = () => filterTable(label);
          filterGroup.appendChild(btn);
        });
      }

      function resetFilters() {
        document.getElementById("table-search").value = "";
        document.getElementById("time-range-select").value = "all";
        document.getElementById("specificDate").value = "";
        filterTable("all");
        filterByTime("all");
        filterByTimeRange("all");
      }

      function applyCurrentFilters() {
        const predFilter =
          document.querySelector("[data-filter].active")?.dataset.filter ||
          "all";
        const timeFilter =
          document.querySelector("[data-time-filter].active")?.dataset
            .timeFilter || "all";
        const timeRange = document.getElementById("time-range-select").value;
        filterTable(predFilter);
        filterByTime(timeFilter);
        filterByTimeRange(timeRange);
        searchTable();
      }

      const heading = document.querySelector(".dashboard-title");
      setInterval(() => {
        heading.classList.add("glitch-animate");
        setTimeout(() => {
          heading.classList.remove("glitch-animate");
        }, 900);
      }, 1000);

      async function analyzeRow(rowData, btnElem) {
        try {
          btnElem.disabled = true;
          btnElem.innerText = "";
          btnElem.classList.add("working");
          console.log("Sending AI analysis request:", rowData);
          const response = await fetch("/analyze_ai", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ row: rowData }),
          });
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          const data = await response.json();
          console.log("AI analysis response:", data);
          let dialog = document.createElement("div");
          dialog.className = "alert alert-primary mt-2";
          dialog.style.position = "relative";
          dialog.innerHTML =
            "<b>AI:-->></b> " + (data.answer || "No recommendation available");
          btnElem.parentNode.appendChild(dialog);
        } catch (error) {
          console.error("AI analysis error:", error);
          let dialog = document.createElement("div");
          dialog.className = "alert alert-danger mt-2";
          dialog.innerHTML = "<b>Error:</b> Failed to fetch AI recommendations";
          btnElem.parentNode.appendChild(dialog);
        } finally {
          btnElem.disabled = false;
          btnElem.innerText = "AI Recommendations";
          btnElem.classList.remove("working");
        }
      }

      const predictionColors = {
        "Benign": "#36A2EB",
        "SQL Injection": "#FF6384",
        "Brute Force -XSS": "#FF4500",
        "SSH-Bruteforce": "#00FF7F",
        "DoS attacks-Slowloris": "#FFD700",
        "Infiltration": "#FFA07A",
        "DoS attacks-GoldenEye": "#FF69B4",
        "DoS attacks-Hulk": "#DC143C",
        "Brute Force -Web": "#9932CC",
        "FTP-BruteForce": "#20B2AA",
        "DDOS attack-LOIC-UDP": "#FF8C00",
        "DoS attacks-SlowHTTPTest": "#4682B4",
        "DDOS attack-HOIC": "#ADFF2F",
      };

      let map;
      document.addEventListener("DOMContentLoaded", function () {
        // Register the datalabels plugin
        Chart.register(ChartDataLabels);
        
        const ctx = document.getElementById("predictionChart").getContext("2d");
        window.predictionChart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: [],
            datasets: [
              {
                data: [],
                backgroundColor: [],
                borderWidth: 2,
                borderColor: "#1c1c1c",
                hoverOffset: 20,
              },
            ],
          },
          plugins: [ChartDataLabels],
          options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 1,
            cutout: "60%",
            plugins: {
              datalabels: {
                color: function(context) {
                  return '#ffffff';
                },
                backgroundColor: function(context) {
                  return 'rgba(0, 0, 0, 0.7)';
                },
                borderColor: '#ffffff',
                borderRadius: 4,
                borderWidth: 1,
                font: {
                  weight: 'bold',
                  size: 16
                },
                padding: 4,
                formatter: function(value, context) {
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = Math.round((value / total) * 100);
                  return percentage + '%';
                },
                display: true,
                anchor: 'center',
                align: 'center'
              },
              legend: {
                position: "bottom",
                labels: {
                  color: "#999999",
                  font: { family: "Roboto", size: 14 },
                  padding: 20,
                  boxWidth: 15,
                },
              },
              tooltip: {
                backgroundColor: "rgba(30, 41, 59, 0.9)",
                titleFont: { family: "Roboto", size: 14 },
                bodyFont: { family: "Roboto", size: 12 },
                padding: 12,
                callbacks: {
                  label: function (tooltipItem) {
                    return `${tooltipItem.label}: ${
                      tooltipItem.raw
                    } (${Math.round(
                      (tooltipItem.parsed /
                        tooltipItem.dataset.data.reduce((a, b) => a + b, 0)) *
                        100
                    )}%)`;
                  },
                },
              },
            },
            animation: {
              animateScale: true,
              animateRotate: true,
            },
            onClick: (event, elements) => {
              if (elements.length > 0) {
                const index = elements[0].index;
                const label = window.predictionChart.data.labels[index];
                filterTable(label === "No Data" ? "all" : label);
              }
            },
          },
        });

        map = L.map("map").setView([0, 0], 2);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution:
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        }).addTo(map);
        updateMap();

        updateChart();
        updateFilterCounts();
        updateSavedSearches();

        document.querySelectorAll(".filter-header").forEach((header) => {
          header.addEventListener("click", () => {
            const content = header.nextElementSibling;
            content.classList.toggle("collapsed");
            const chevron = header.querySelector(
              ".fa-chevron-down, .fa-chevron-up"
            );
            chevron.classList.toggle("fa-chevron-up");
            chevron.classList.toggle("fa-chevron-down");
          });
        });

        document
          .getElementById("time-range-select")
          .addEventListener("change", (e) => {
            filterByTimeRange(e.target.value);
          });

        document
          .getElementById("saved-searches")
          ?.addEventListener("change", loadSavedSearch);

        document.querySelectorAll("#result-table tr").forEach((row) => {
          row.addEventListener("click", () => {
            const rowData = JSON.parse(row.dataset.row);
            showModal(rowData);
          });
          row.addEventListener("mouseenter", (e) => {
            const sourceIP = row.children[1].textContent;
            const destIP = row.children[2].textContent;
            const prediction = row.dataset.pred;
            const tooltip = document.createElement("div");
            tooltip.className = "row-tooltip";
            tooltip.textContent = `Source IP: ${sourceIP}\nDestination IP: ${destIP}\nPrediction: ${prediction}`;
            document.body.appendChild(tooltip);
            const rect = row.getBoundingClientRect();
            tooltip.style.top = `${
              rect.top + window.scrollY - tooltip.offsetHeight - 10
            }px`;
            tooltip.style.left = `${
              rect.left + window.scrollX + rect.width / 2
            }px`;
            tooltip.style.display = "block";
          });
          row.addEventListener("mouseleave", () => {
            document
              .querySelectorAll(".row-tooltip")
              .forEach((t) => t.remove());
          });
          row.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              const aiButton = row.querySelector(".ai-analyze-btn");
              if (aiButton) aiButton.click();
              else showModal(JSON.parse(row.dataset.row));
            }
          });
        });

        document.addEventListener("click", (e) => {
          const modal = document.getElementById("row-details-modal");
          if (e.target === modal) closeModal();
        });
      });

      function updateChart() {
        const rows = document.querySelectorAll("#result-table tr");
        const predictionCounts = {
          Benign: 0,
          "SQL Injection": 0,
          "Brute Force -XSS": 0,
          "SSH-Bruteforce": 0,
          "DoS attacks-Slowloris": 0,
          Infiltration: 0,
          "DoS attacks-GoldenEye": 0,
          "DoS attacks-Hulk": 0,
          "Brute Force -Web": 0,
          "FTP-BruteForce": 0,
          "DDOS attack-LOIC-UDP": 0,
          "DoS attacks-SlowHTTPTest": 0,
          "DDOS attack-HOIC": 0,
        };

        rows.forEach((row) => {
          if (row.style.display !== "none") {
            const predText = row.dataset.pred?.trim();
            if (predictionCounts.hasOwnProperty(predText)) {
              predictionCounts[predText]++;
            }
          }
        });

        const labels = [];
        const data = [];
        const colors = [];
        for (const [label, count] of Object.entries(predictionCounts)) {
          if (count > 0) {
            labels.push(label);
            data.push(count);
            colors.push(predictionColors[label] || "#CCCCCC");
          }
        }

        if (labels.length === 0) {
          labels.push("No Data");
          data.push(1);
          colors.push("#CCCCCC");
        }

        window.predictionChart.data.labels = labels;
        window.predictionChart.data.datasets[0].data = data;
        window.predictionChart.data.datasets[0].backgroundColor = colors;
        window.predictionChart.update();
      }

      async function updateMap() {
        map.eachLayer((layer) => {
          if (layer instanceof L.Marker) map.removeLayer(layer);
        });

        const rows = document.querySelectorAll("#result-table tr");
        for (const row of rows) {
          if (row.style.display === "none") continue;
          const sourceIP = row.children[1].textContent;
          try {
            const response = await fetch(`https://ipapi.co/${sourceIP}/json/`);
            const data = await response.json();
            if (data.latitude && data.longitude) {
              const markerColor = row.classList.contains("pred-attack")
                ? "#ff4d4d"
                : "#36A2EB";
              L.circleMarker([data.latitude, data.longitude], {
                radius: 8,
                color: markerColor,
                fillColor: markerColor,
                fillOpacity: 0.8,
              })
                .addTo(map)
                .bindPopup(
                  `Source IP: ${sourceIP}<br>Prediction: ${row.dataset.pred}`
                );
            }
          } catch (error) {
            console.error("Error fetching geolocation:", error);
          }
        }
      }

      document.getElementById("theme-toggle").addEventListener("click", () => {
        document.body.classList.toggle("light-theme");
        const icon = document.querySelector("#theme-toggle i");
        icon.className = document.body.classList.contains("light-theme")
          ? "fas fa-sun"
          : "fas fa-moon";
      });
      function updateTime() {
    const now = new Date();
    const formatted = now.toLocaleDateString('en-GB') + ' ' +
        now.toLocaleTimeString('en-GB', { hour12: false });
    document.getElementById('current-time').textContent = formatted;
}
setInterval(updateTime, 1000);
updateTime();

// وظائف زر العودة لأعلى
function scrollToTop() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
}

// إظهار/إخفاء الزر حسب موضع الصفحة
window.addEventListener('scroll', function() {
    const backToTopBtn = document.getElementById('backToTop');
    if (window.pageYOffset > 300) {
        backToTopBtn.classList.add('show');
    } else {
        backToTopBtn.classList.remove('show');
    }
});

// إخفاء الزر في البداية
document.addEventListener('DOMContentLoaded', function() {
    const backToTopBtn = document.getElementById('backToTop');
    backToTopBtn.classList.remove('show');
});
    </script>
    
    <!-- زر العودة لأعلى الصفحة -->
    <button class="back-to-top" id="backToTop" onclick="scrollToTop()" aria-label="العودة لأعلى الصفحة">
      <i class="fas fa-chevron-up"></i>
    </button>
    
  </body>
</html>